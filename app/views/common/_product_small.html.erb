<% product = product_small %>
<div id="<%=dom_id(product)%>" class="span-17" style="margin-bottom:10px;">
  <div class="span-12">
    <div class="span-2">
      <%= image_for(product) %>
    </div>
    <div class="span-5">
      <p><b><%= product.category_prefix %>:<%= link_to product.title, account_product_path(product.account,product) %></b><br />
         From <%= link_to product.account.name, account_path(product.account) %><br />
         <%= product.description %></p>
    </div>
    <div class="span-5 last">
      <p><%= product.formatted_price %> per <%= product.ordering_unit %><br />
         <%= product.available_orderables.count %> available for purchase<br />
         <% if can_edit(product) %>
           <%= product.carted_orderables.count %> in shopping carts<br />
           <%= product.ordered_orderables.count %> in completed orders<br />
         <% end %>
         <% if @current_user and @current_user.current_order %>
           <%= @current_user.current_order.count_product(product) %> in 
           <%= (@current_user.current_order.final ? ' your completed order' : ' your shopping cart') %>
         <% end %>
    </div>
  </div> 

  <div class="span-5 last">
    <ul>
      <!-- products can be edited or deleted when there is no cycle or when ordering is not yet open -->
      <% if can_edit(product) and 
        (!@current_delivery_cycle or (@current_delivery_cycle and @current_delivery_cycle.is_before_order)) %>
        <li><%= link_to 'Edit', edit_account_product_path(product.account,product) %></li>
        <li><%= link_to 'Delete', account_product_path(product.account,product), :method => :delete %></li>
      <% end %>
      <!-- inventory can be changed any time if there is a current cycle open and the product was
           not added after ordering opened in that cycle -->
      <% if can_edit(product) and @current_delivery_cycle and product.can_make_orderable(@current_delivery_cycle) %>
        <li>Adjust inventory:<br />
          <% form_remote_tag :url => make_orderable_account_product_path(product.account,product) do -%>
              <div style="margin-left:10px;"><%= text_field_tag 'number', 0, :size => 2 %> <%= submit_tag 'add' %></div>
            <% end -%>
          <% form_remote_tag :url => remove_orderable_account_product_path(product.account,product) do -%>
              <div style="margin-left:10px;"><%= text_field_tag 'number', 0, :size => 2 %> <%= submit_tag 'drop' %></div>
            <% end -%>
        </li>
      <% elsif @current_delivery_cycle and !product.can_make_orderable(@current_delivery_cycle) %>
        <li>Inventory adjustment not available until next cycle.</li>
      <% end %>
      <% if @current_user and @current_delivery_cycle and @current_delivery_cycle.is_order and product.available_orderables.count > 0 %>
        <li><%= link_to 'Add to cart', add_to_cart_user_url(@current_user, :product_id => product.id) %></li>
      <% end %>
    </ul>
  </div>
</div>
